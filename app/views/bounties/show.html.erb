<% title @bounty.title, "##{@bounty.number}", @bounty.product.name %>
<% description Nokogiri::HTML(product_markdown(@bounty.product, @bounty.description)).text %>
<% activate_nav! :bounties %>

<%= track 'product.wip.viewed', WipAnalyticsSerializer.new(@wip, scope: current_user) %>

<div class="card mb0">
  <%= react_component 'Bounty', {
      bounty: BountySerializer.new(@bounty, scope: current_user),
      item: (NewsFeedItemSerializer.new(@bounty.news_feed_item) if @bounty.news_feed_item),
      valuation: {
        product: { name: @product.name },
        url: product_wips_path(@product),
        maxOffer: (6 * @product.average_bounty).round(-4),
        averageBounty: @product.average_bounty,
        coinsMinted: @product.coins_minted,
        profitLastMonth: @product.profit_last_month,
        steps: BountyGuidance::Valuations.suggestions(@product)
      },
      showCoins: !@product.meta?
    } %>
</div>

<div class="px3" id="discussion-view-el">
  <%= render 'wips/discussion', events: @events %>
  <%= render 'new_event_form' %>
</div>

<% if signed_in? %>
  <img class="hidden" data-src="<%= ReadraptorTracker.new(ReadRaptorSerializer.serialize_entities(@bounty).first, current_user.id).url %>" />
<% end %>

<% content_for :javascript do %>
  <script>
    app.product = new Product(<%= json @bounty.product, scope: current_user %>);
    app.wip = new Wip(<%== WipSerializer.new(@bounty, scope: current_user).to_json %>);
    app.wipEvents = new WipEvents(<%== @bounty.events.map {|e| EventSerializer.for(e, current_user)}.to_json %>, {
      url: '<%= product_wip_comments_path(@bounty.product, @bounty) %>'
    });

    <% if signed_in? %>
      <% story_id = Story.associated_with_ids(@bounty).first %>
      app.wip.readRaptorUrl = '<%== ReadraptorTracker.new(story_id, current_user.id).url if story_id %>';
    <% end %>

    $(document).ready(function() {
      <%= render 'wips/add_tips_to_wip_events' %>

      app.discussionView = new DiscussionView({
        el: $('#discussion-view-el'),
        tipsPath: '<%= product_tips_path(@bounty.product) %>',
        model: app.wip
      });
    })
  </script>
<% end %>
