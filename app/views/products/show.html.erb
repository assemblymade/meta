<% title @product.name, @product.pitch %>
<% activate_nav! :product %>
<% @missionAutoOpen = false %>

<%= render 'shared/navbar' %>
<%= render 'products/navbar' %>

<!-- <% if flash[:new_product_callout] %>
  <br>
  <div class="callout container">
    <div class="callout-content">
      <div class="mission-creator-intro">
        <h1>Hit the ground running.</h1>
        <p>
          It looks like you’re off to a great start with the product. Great work! Until you get your bearings around here, you’ll be tasked with metric-driven missions to complete, leveling-up the product; giving it the best chance at becoming a shipping product.
        </p>
      </div>
    </div>
    <div class="callout-actions">
      <div class="pull-left">
        <span class="text-muted">Current Goal:</span>
        <%= ProductMissionDecorator.new(@product.current_mission).translate(:name) %>
      </div>

      <div class="pull-right">
        <button class="btn btn-primary" data-click-trigger="mission.flyout.open">
          Start reaching goals
        </a>
      </div>
    </div>
  </div>
<% elsif !signed_in? && !@product.meta? %>
  <br>
  <div class="callout container">
    <div class="callout-content">
      <div class="mission-creator-intro">
        <h1>Welcome to Assembly!</h1>
        <p>
          <%= @product.name %> is a mutual product on Assembly, built and owned by the people who use it. The Assembly open platform enables anyone around the world to openly develop products together. We reliably host them, keeping your data safe, and split the profit among the people that built it at the end of every month.
        </p>
      </div>
    </div>
  </div>
<% end %> -->

<div class="page">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-xs-8">

        <!-- Pitch -->

        <h2 class="alpha"><strong><%= @product.pitch %></strong></h2>

        <% unless @product.lead.blank? %>
          <div class="text-large">
            <%== @product.lead_html %>
          </div>
        <% end %>

        <!-- Poster Image -->
        <hr>


        <!-- Body -->
        <div class="markdown-normalized text-longform">
          <%== @product.description_html %>
        </div>
      </div>


      <div class="col-md-3 col-xs-3 col-md-offset-1 col-xs-offset-1">
        <%= render 'products/sidebar' %>

        <!-- Social links -->

        <%#= render 'products/social_buttons' %>

        <% if @product.homepage_url.present? || @product.repos.any? %>
          <div class="panel panel-default">

            <div class="panel-heading">
              <h6 class="panel-title">Links</h6>
            </div>
            <div class="panel-body">
              <% unless @product.homepage_url.blank? %>
                <a href="<%= @product.homepage_url %>" data-track="product.site.clicked">
                  <strong><%= @product.homepage_url %></strong>
                </a>
              <% end %>
              <% unless @product.homepage_url.blank? && @product.repos.any? %>
                <hr style="margin-top: 15px; margin-bottom: 15px;">
              <% end %>
              <% if @product.for_profit? && @product.repos.any? %>
                <ul class="list-unstyled omega">
                  <% @product.repos.each do |repo| %>
                    <li>
                      <span class="icon icon-github" style="margin-right: 4px;"></span>
                      <a href="<%= repo.url %>" data-track="product.repo.clicked">
                        <strong><%= repo.name %></strong>
                      </a>
                    </li>
                  <% end %>
                </ul>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if !@product.for_profit? %>
          <div class="panel panel-warning">
            <div class="panel-heading">
              <h6 class="panel-title">Special Project</h6>
            </div>
            <div class="panel-body small">
              <p class="omega"><strong>Assembly Meta</strong> is a special product for providing feedback to Assembly and to join the discussion on upcoming features. This is not intended for revenue so there won't be any royalties paid. App Coins have been replaced with Karma to make this clear.</p>
            </div>
          </div>
        <% end %>

        <!-- People Panel -->
        <div class="panel panel-default">
          <div class="panel-heading">
            <h6 class="panel-title">Core Team</h6>
          </div>
          <div class="panel-body small">
            <% if @product.core_team.empty? %>
              <p class="omega">No core team members yet.</p>
            <% else %>
              <ul class="list-grid omega">
                <% @product.core_team.each do |user| %>
                  <li>
                    <a href="<%= user_path(user) %>" title="<%= user.username %>"><%= avatar_tag(user, 36) %></a>
                  </li>
                <% end %>
              </ul>
            <% end %>
          </div>

          <div class="panel-heading">
            <h6 class="panel-title">Contributors</h6>
          </div>

          <div class="panel-body small">
            <% if @product.contributors.empty? %>
              <p class="omega">No contributors yet.</p>
            <% else %>

              <ul class="list-grid omega">
                <% @product.important_contributors.each do |user| %>
                  <li>
                    <a href="<%= user_path(user) %>" title="<%= user.username %>">
                      <%= avatar_tag(user, 21) %>
                    </a>
                  </li>
                <% end %>
              </ul>

              <!-- FIXME: Most of these should be in another decorator -->
              <% if @product.uninmportant_contributors_count > 0 %>
                <p class="text-center omega" style="margin-top:15px">
                  <a href="<%= product_jobs_path(@product) %>">
                    Plus <%= @product.uninmportant_contributors_count %> more
                  </a>
                </p>
              <% end %>
            <% end %>
          </div>
        </div>


        <% if @product.greenlit? %>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h6 class="panel-title">
                This product is live!
              </h6>
            </div>
            <div class="panel-body small">

              <p>To sign up, visit <a href="<%= @product.homepage_url %>" target='product'><%= @product.name %></a> now or you can get started using <%= @product.name %> here with your Assembly account.</p>

              <form method="post" action="<%= vote_idea_path(@product) %>">
                <input name="authenticity_token" value="<%= form_authenticity_token %>" type="hidden">
                <% if @product.voted_for_by?(current_user) %>
                  <input type="submit" value="Signed up" class="btn btn-default btn-sm btn-block" disabled="disabled">
                <% else %>
                  <input type="submit" value="Sign up" class="btn btn-default btn-sm btn-block">
                <% end %>
              </form>
            </div>
          </div>

          <% if @product.has_metrics? %>
            <% cache ['v1', @product], expires_in: 12.hours do %>
              <%= render 'products/panels/metrics' %>
            <% end %>
          <% end %>

        <% else %>

          <% if @product.has_metrics? %>
            <% cache ['v1', @product], expires_in: 12.hours do %>
              <%= render 'products/panels/metrics' %>
            <% end %>
          <% end %>

          <% if @product.has_preorders? %>
            <!-- Pre-orders Panel -->
            <div class="panel panel-default">
              <div class="panel-heading">
                <h6 class="panel-title">Pre-Orders</h6>
              </div>

              <div class="list-group small">
                <div class="list-group-item">
                  <div class="pull-right">$0.00</div>
                  Free
                  <p class="text-muted">
                    <%= @product.free_perk %>
                  </p>
                  <form method="post" action="<%= vote_idea_path(@product) %>">
                    <input name="authenticity_token" value="<%= form_authenticity_token %>" type="hidden">
                    <input type="submit" value="<%= @product.signup_button_copy(current_user) %>" class="btn btn-default btn-sm btn-block <%= "disabled" if @product.voted_for_by?(current_user) %>">
                  </form>
                </div>


                <% @perks.each do |perk| %>
                  <div class="list-group-item">
                    <div class="pull-right">
                      <%= amount_to_currency(perk.amount) %>
                    </div>
                    <%= perk.name %>
                    <p class="text-muted">
                      <%= perk.description %>
                    </p>
                    <a href="<%= new_perk_preorder_path(perk) %>" class="btn btn-default btn-block btn-sm <%= "disabled" if current_user && current_user.preordered_perk?(perk) %>">
                      <%= perk.formatted_amount(current_user) %>
                    </a>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>

        <!-- Tags Panel -->
        <% if @product.tags.present? %>
          <div class="panel panel-default">
            <div class="panel-heading">
              <h6 class="panel-title">Tags</h6>
            </div>
            <div class="panel-body">
              <ul class="list-grid omega">
                <% @product.tags.each do |tag| %>
                  <li><span class="label label-info"><%= tag %></span></li>
                <% end %>
              <ul>
            </div>
          </div>
        <% end %>

        <% if can?(:update, @product) %>
          <div class="btn-group-vertical btn-block">
            <a class="btn btn-default" href="<%= edit_product_path(@product) %>">Edit Product</a>
            <a class="btn btn-default" href="<%=  new_product_post_path(@product) %>">Write blog post</a>
          </div>
        <% end %>

        <% if staff? %>
          <br><br>
          <div class="panel panel-danger">
            <div class="panel-heading">
              <h6 class="panel-title">DANGER</h6>
            </div>
            <div class="panel-body">
              <% if @product.flagged? %>
                <span class="btn btn-danger btn-sm btn-block btn-disabled" href="#>">Product Flagged</span>
              <% else %>
                <a class="btn btn-danger btn-sm btn-block" href="<%= product_flag_path(@product)%>">Flag Product</a>
              <% end %>

              <br>

              <%= form_for [:admin, @product.showcases.new], url: admin_staff_picks_path do |f| %>
                <%= f.hidden_field :product_id %>
                <%= f.submit "Schedule Staff Pick", class: %w(btn btn-default btn-sm btn-block) %>
              <% end %>
            </div>
          </div>
        <% end %>

      </div>
    </div><!-- .row -->
  </div><!-- .container -->
</div>

<%= render 'shared/footer' %>

<% if current_user.try(:staff?) != true %>
  <script>
    analytics.track('product.viewed', <%==
      ProductAnalyticsSerializer.new(@product, scope: current_user).to_json
    %>);
  </script>
<% end %>
